---
title: "RRProj2"
output: html_document
---
## Loading necessary libraries
```{r global_options, include=TRUE}
knitr::opts_chunk$set(fig.width=12, fig.height=8, fig.path='figures/',
                      echo=TRUE, warning=FALSE, message=FALSE)
suppressPackageStartupMessages(library(dplyr))
suppressPackageStartupMessages(library(fuzzyjoin))
```

## Download and load file
```{r}
download.file("https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2","stormdata.csv.bz2")

stormdata<-read.csv("stormdata.csv.bz2")
```


## Subset
Subset data to the necessary columns.
```{r}
eventtype<-stormdata %>% select(EVTYPE,FATALITIES,INJURIES) %>% transform(EVTYPE=tolower(EVTYPE)) %>% arrange(EVTYPE)
event.join<-eventtype.table %>% stringdist_left_join(eventcat,method="lcs",ignore_case=TRUE,max_dist=1)
#add event category column
eventtype[,"EVCAT"]<-0

```

## Clean the event types to correspond to the 48 listed types
I collapsed the event types into appropriate groups. To do this, I added an event category column to avoid changing the raw data. I then used regular expression functions to identify the categories, and set the category column for those events to one of the 48 categories listed in the accompanying documentation. Any event that could not be easily classified was defined as 'other'. To classify each category, the category pattern was selected and viewed. If one occurrence had multiple events, it was classifed by the most likely cause of injury or destruction. For example, excessive heat causes more injuries and fatalities than drought, and therefore excessive heat/drought was classified as excessive heat. Tornadoes are more destructive than thunderstorm wind and hail, so 'tornadoes, tstm wind, hail' was classified as tornado. 

Notes:
Landslide and avalanche were combined
Blow-out tide added to astronomical low tide
Excessive heat/drought classified as excessive heat
Cold/Wind Chill combined with Extreme Cold/Wind Chill
Heavy snow/ice storm classified as heavy snow
The wind categories should be run last to avoid conflicts


```{r}
#adjust avalanche and landslide
avalanche<-unique(eventtype$EVTYPE[grepl("*avalan*",eventtype$EVTYPE)|grepl("landslide",eventtype$EVTYPE)])
eventtype$EVCAT[which(eventtype$EVTYPE %in% avalanche & eventtype$EVCAT==0)]<-"avalanche"

#adjust astronomical low tide, add blow-out tide
low.tide<-unique(eventtype$EVTYPE[grepl("low tide",eventtype$EVTYPE)|grepl("blow-out",eventtype$EVTYPE)])
eventtype$EVCAT[which(eventtype$EVTYPE %in% low.tide & eventtype$EVCAT==0)]<-"astronomical low tide"

#adjust blizzard
blizzard<-unique(eventtype$EVTYPE[grepl("*blizzard*",eventtype$EVTYPE)])
eventtype$EVCAT[which(eventtype$EVTYPE %in% blizzard & eventtype$EVCAT==0)]<-"blizzard"

#adjust coastal flooding
coastal.flood<-unique(eventtype$EVTYPE[grepl("coastal",eventtype$EVTYPE)|grepl("beach",eventtype$EVTYPE)])
coastal.storm<-coastal.flood[grepl("storm",coastal.flood)]
coastal.flood<-coastal.flood[!grepl("storm",coastal.flood)]
eventtype$EVCAT[which(eventtype$EVTYPE %in% coastal.flood & eventtype$EVCAT==0)]<-"coastal flood"
eventtype$EVCAT[which(eventtype$EVTYPE %in% coastal.storm & eventtype$EVCAT==0)]<-"coastal storm"


#cold/wind chill
wind.chill<-unique(eventtype$EVTYPE[grepl("wind chill",eventtype$EVTYPE)|grepl("cold",eventtype$EVTYPE)|grepl("extremewind",eventtype$EVTYPE)])
wind.chill<-wind.chill[!grepl("blizzard",wind.chill) & !grepl("tornado",wind.chill) & !grepl("fog",wind.chill) & !grepl("frost",wind.chill)]
eventtype$EVCAT[which(eventtype$EVTYPE %in% wind.chill & eventtype$EVCAT==0)]<-"extreme cold/wind chill"

#No debris flow

#Dense Fog, freezing fog
fog<-unique(eventtype$EVTYPE[grepl("fog",eventtype$EVTYPE)])
freeze.fog<-fog[grepl("freezing",fog)|grepl("ice",fog)]
fog<-fog[!grepl("freezing",fog)&!grepl("ice",fog)]
eventtype$EVCAT[which(eventtype$EVTYPE %in% fog & eventtype$EVCAT==0)]<-"dense fog"
eventtype$EVCAT[which(eventtype$EVTYPE %in% freeze.fog & eventtype$EVCAT==0)]<-"freezing fog"

#Dense Smoke
smoke<-unique(eventtype$EVTYPE[grepl("smoke",eventtype$EVTYPE)])
eventtype$EVCAT[which(eventtype$EVTYPE %in% smoke & eventtype$EVCAT==0)]<-"dense smoke"

#drought, excessive heat/drought classified as excessive heat
drought<-unique(eventtype$EVTYPE[grepl("drought",eventtype$EVTYPE)|grepl("abnormally dry",eventtype$EVTYPE)|grepl("excessively dry",eventtype$EVTYPE)|grepl("record dry",eventtype$EVTYPE)])
drought<-drought[!grepl("excessive heat",drought)]
eventtype$EVCAT[which(eventtype$EVTYPE %in% drought & eventtype$EVCAT==0)]<-"drought"

#dust devil and dust storm
dust.devil<-unique(eventtype$EVTYPE[grepl("dust",eventtype$EVTYPE)])
dust.storm<-dust.devil[grepl("storm",dust.devil)]
dust.devil<-dust.devil[!grepl("storm",dust.devil)]

eventtype$EVCAT[which(eventtype$EVTYPE %in% dust.devil & eventtype$EVCAT==0)]<-"dust devil"
eventtype$EVCAT[which(eventtype$EVTYPE %in% dust.storm & eventtype$EVCAT==0)]<-"dust storm"

#Excessive heat
#adjust excessive heat
heat<-unique(eventtype$EVTYPE[grepl("heat",eventtype$EVTYPE)| grepl("abnormal warmth",eventtype$EVTYPE)])
eventtype$EVCAT[which(eventtype$EVTYPE %in% heat & eventtype$EVCAT==0)]<-"excessive heat"

#Flash flood, flood, lakeshore flood
flood<-unique(eventtype$EVTYPE[grepl("*flood*",eventtype$EVTYPE)|grepl("*fld*",eventtype$EVTYPE) | grepl("dam",eventtype$EVTYPE)])
flash.flood<-flood[grepl("flash",flood)]
lake.flood<-flood[grepl("lake",flood)]
flood<-flood[!grepl("coastal",flood)&!grepl("flash",flood)& !grepl("red",flood)& !grepl("beach",flood)&!grepl("lake",flood)]
eventtype$EVCAT[which(eventtype$EVTYPE %in% flood & eventtype$EVCAT==0)]<-"flood"
eventtype$EVCAT[which(eventtype$EVTYPE %in% flash.flood & eventtype$EVCAT==0)]<-"flash flood"
eventtype$EVCAT[which(eventtype$EVTYPE %in% lake.flood & eventtype$EVCAT==0)]<-"lakeshore flood"

#frost/freeze
frost<-unique(eventtype$EVTYPE[grepl("frost",eventtype$EVTYPE)|grepl("freez",eventtype$EVTYPE)])
frost<-frost[!grepl("fog",frost) & !grepl("blizzard",frost) & !grepl("rain",frost) & !grepl("sleet",frost) & !grepl("record cold",frost)]
eventtype$EVCAT[which(eventtype$EVTYPE %in% frost & eventtype$EVCAT==0)]<-"frost/freeze"

#Funnel Cloud
funnel<-unique(eventtype$EVTYPE[grepl("funnel",eventtype$EVTYPE)])
funnel<-funnel[!grepl("wind",funnel) & !grepl("water",funnel) & !grepl("cold",funnel) & !grepl("hail",funnel)]
eventtype$EVCAT[which(eventtype$EVTYPE %in% funnel & eventtype$EVCAT==0)]<-"funnel cloud"

#Hail
hail<-unique(eventtype$EVTYPE[grepl("hail",eventtype$EVTYPE)])
marine.hail<-hail[grepl("marine",hail)]
hail<-hail[!grepl("flood",hail) & !grepl("marine",hail) & !grepl("tornado",hail)]
eventtype$EVCAT[which(eventtype$EVTYPE %in% hail & eventtype$EVCAT==0)]<-"hail"
eventtype$EVCAT[which(eventtype$EVTYPE %in% marine.hail & eventtype$EVCAT==0)]<-"marine hail"

#heavy rain
rain<-unique(eventtype$EVTYPE[grepl("rain",eventtype$EVTYPE) | grepl("precip",eventtype$EVTYPE)])
rain<-rain[!grepl("flood",rain) & !grepl("blizzard",rain) & !grepl("freez",rain) & !grepl("lightning",rain) & !grepl("record low",rain) & !grepl("sleet",rain) & !grepl("thunderstorm",rain) & !grepl("tstm",rain) & !grepl("surf",rain) & !grepl("below",rain)]
eventtype$EVCAT[which(eventtype$EVTYPE %in% rain & eventtype$EVCAT==0)]<-"heavy rain"

#heavy snow
snow<-unique(eventtype$EVTYPE[grepl("snow",eventtype$EVTYPE)])
snow<-snow[grepl("heavy",snow) | grepl("excessive",snow) | grepl("record",snow) & !grepl("lake",snow) & !grepl("blizzard",snow)]
eventtype$EVCAT[which(eventtype$EVTYPE %in% snow & eventtype$EVCAT==0)]<-"heavy snow"

#High surf
surf<-unique(eventtype$EVTYPE[grepl("surf",eventtype$EVTYPE)|grepl("swell",eventtype$EVTYPE)])
surf<-surf[!grepl("rip",surf)]
eventtype$EVCAT[which(eventtype$EVTYPE %in% surf & eventtype$EVCAT==0)]<-"high surf"

#adjust hurricane
hurricane<-unique(eventtype$EVTYPE[grepl("hurricane", eventtype$EVTYPE)])
hurricane<-hurricane[!grepl("swell",hurricane)]
eventtype$EVCAT[which(eventtype$EVTYPE %in% hurricane & eventtype$EVCAT==0)]<-"hurricane"

#ice
ice<-unique(eventtype$EVTYPE[grepl("ice storm",eventtype$EVTYPE)])
ice<-ice[!grepl("heavy snow",ice) & !grepl("flood",ice)]
eventtype$EVCAT[which(eventtype$EVTYPE %in% ice & eventtype$EVCAT==0)]<-"ice storm"

#lake-effect snow
lake.snow<-unique(eventtype$EVTYPE[grepl("lake",eventtype$EVTYPE) & grepl("snow",eventtype$EVTYPE)])
eventtype$EVCAT[which(eventtype$EVTYPE %in% lake.snow & eventtype$EVCAT==0)]<-"lake-effect snow"

#lightning
lightning<-unique(eventtype$EVTYPE[grepl("light",eventtype$EVTYPE)|grepl("ning",eventtype$EVTYPE)])
lightning<-lightning[!grepl("freezing",lightning) & !grepl("snow",lightning) & !grepl("northern",lightning)]
eventtype$EVCAT[which(eventtype$EVTYPE %in% lightning & eventtype$EVCAT==0)]<-"lightning"

#marine
marine<-unique(eventtype$EVTYPE[grepl("marine",eventtype$EVTYPE)])
marine.other<-marine[grepl("accident",marine) | grepl("mishap",marine)]
marine.high.wind<-marine[grepl("high wind",marine)]
marine.strong.wind<-marine[grepl("strong wind",marine)]
marine.thunderstorm<-marine[grepl("thunderstorm",marine) | grepl("tstm",marine)]

eventtype$EVCAT[which(eventtype$EVTYPE %in% marine.other & eventtype$EVCAT==0)]<-"marine other"
eventtype$EVCAT[which(eventtype$EVTYPE %in% marine.high.wind & eventtype$EVCAT==0)]<-"marine high wind"
eventtype$EVCAT[which(eventtype$EVTYPE %in% marine.strong.wind & eventtype$EVCAT==0)]<-"marine strong wind"
eventtype$EVCAT[which(eventtype$EVTYPE %in% marine.thunderstorm & eventtype$EVCAT==0)]<-"marine thunderstorm wind"

#rip current
rip.current<-unique(eventtype$EVTYPE[grepl("rip",eventtype$EVTYPE)])
eventtype$EVCAT[which(eventtype$EVTYPE %in% rip.current & eventtype$EVCAT==0)]<-"rip current"

#seiche
seiche<-unique(eventtype$EVTYPE[grepl("seiche",eventtype$EVTYPE)])
eventtype$EVCAT[which(eventtype$EVTYPE %in% seiche & eventtype$EVCAT==0)]<-"seiche"

#sleet
sleet<-unique(eventtype$EVTYPE[grepl("sleet",eventtype$EVTYPE)])
sleet<-sleet[!grepl("ice storm",sleet)]
eventtype$EVCAT[which(eventtype$EVTYPE %in% sleet & eventtype$EVCAT==0)]<-"sleet"

#storm surge
surge<-unique(eventtype$EVTYPE[grepl("storm surge",eventtype$EVTYPE)])
eventtype$EVCAT[which(eventtype$EVTYPE %in% surge & eventtype$EVCAT==0)]<-"storm surge/tide"

#Thunderstorm
thunderstorm<-unique(eventtype$EVTYPE[grepl("thunderstorm",eventtype$EVTYPE)|grepl("tstm",eventtype$EVTYPE)|grepl("orm wind",eventtype$EVTYPE)|grepl("om winds",eventtype$EVTYPE)])
thunderstorm<-thunderstorm[!grepl("marine",thunderstorm) & !grepl("non",thunderstorm) & !grepl("hail",thunderstorm)]
eventtype$EVCAT[which(eventtype$EVTYPE %in% thunderstorm & eventtype$EVCAT==0)]<-"thunderstorm"

#Tornado
tornado<-unique(eventtype$EVTYPE[grepl("*tornado*",eventtype$EVTYPE)])
tornado<-tornado[!grepl("water",tornado)]
eventtype$EVCAT[which(eventtype$EVTYPE %in% tornado & eventtype$EVCAT==0)]<-"tornado"

#tropical
tropical<-unique(eventtype$EVTYPE[grepl("tropical",eventtype$EVTYPE)])
tropical.depression<-tropical[grepl("depression",tropical)]
tropical.storm<-tropical[grepl("storm",tropical)]
eventtype$EVCAT[which(eventtype$EVTYPE %in% tropical.depression & eventtype$EVCAT==0)]<-"tropical depression"
eventtype$EVCAT[which(eventtype$EVTYPE %in% tropical.storm & eventtype$EVCAT==0)]<-"tropical storm"

#tsunami
tsunami<-unique(eventtype$EVTYPE[grepl("tsunami",eventtype$EVTYPE)])
eventtype$EVCAT[which(eventtype$EVTYPE %in% tsunami & eventtype$EVCAT==0)]<-"tsunami"

#volcanic eruption/ash
volcano<-unique(eventtype$EVTYPE[grepl("volcan",eventtype$EVTYPE)])
eventtype$EVCAT[which(eventtype$EVTYPE %in% volcano & eventtype$EVCAT==0)]<-"volcanic ash/eruption"

#waterspout
waterspout<-unique(eventtype$EVTYPE[grepl("waterspout",eventtype$EVTYPE)])
waterspout<-waterspout[!grepl("dust",waterspout)]
eventtype$EVCAT[which(eventtype$EVTYPE %in% waterspout & eventtype$EVCAT==0)]<-"waterspout"

#wildfire
wildfire<-unique(eventtype$EVTYPE[grepl("fire",eventtype$EVTYPE)])
wildfire<-wildfire[!grepl("red",wildfire) & !grepl("lightning",wildfire)]
eventtype$EVCAT[which(eventtype$EVTYPE %in% wildfire & eventtype$EVCAT==0)]<-"wildfire"

#winter storm
winter.storm<-unique(eventtype$EVTYPE[grepl("winter storm",eventtype$EVTYPE)])
winter.storm<-winter.storm[!grepl("blizzard",winter.storm) & !grepl("heavy snow",winter.storm)]
eventtype$EVCAT[which(eventtype$EVTYPE %in% winter.storm & eventtype$EVCAT==0)]<-"winter storm"

#winter weather
winter.weather<-unique(eventtype$EVTYPE[grepl("winter",eventtype$EVTYPE)| grepl("snow",eventtype$EVTYPE) | grepl("freezing",eventtype$EVTYPE) | grepl("ice",eventtype$EVTYPE)| grepl("icy",eventtype$EVTYPE)])
winter.weather<-winter.weather[!grepl("blizzard",winter.weather) & !grepl("fog",winter.weather) & !grepl("sleet",winter.weather) & !grepl("heavy",winter.weather) & !grepl("flood",winter.weather) & !grepl("chill",winter.weather) & !grepl("storm",winter.weather) & !grepl("lake",winter.weather) & !grepl("excessive",winter.weather) & !grepl("record",winter.weather) & !grepl("storm",winter.weather) & !grepl("lack of",winter.weather)]

eventtype$EVCAT[which(eventtype$EVTYPE %in% winter.weather & eventtype$EVCAT==0)]<-"winter weather"

#High wind and strong wind
wind<-unique(eventtype$EVTYPE[grepl("wind",eventtype$EVTYPE)| grepl("microburst",eventtype$EVTYPE) | grepl("downburst",eventtype$EVTYPE)])
high.wind<-wind[grepl("high wind",wind)]
strong.wind<-wind[grepl("strong wind",wind) | grepl("microburst",wind) | grepl("downburst",wind)|grepl("mirco",wind)|grepl("strong",wind)|grepl("gust",wind)]
strong.wind<-strong.wind[!grepl("marine",strong.wind)]
eventtype$EVCAT[which(eventtype$EVTYPE %in% high.wind & eventtype$EVCAT==0)]<-"high wind"
eventtype$EVCAT[which(eventtype$EVTYPE %in% strong.wind & eventtype$EVCAT==0)]<-"strong wind"

#high seas
seas<-unique(eventtype$EVTYPE[grepl("high seas",eventtype$EVTYPE)])
eventtype$EVTYPE[which(eventtype$EVTYPE %in% seas & eventtype$EVCAT==0)]<-"high seas"


```

## Summarize by mortality 
```{r}
eventtype<-eventtype %>% group_by(EVTYPE) %>% summarize(mortality=sum(FATALITIES,INJURIES,na.rm=TRUE)) %>% arrange(desc(mortality))
eventtype<-eventtype[which(eventtype$mortality>0),]
```